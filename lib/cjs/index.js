"use strict";var Encryption,inquirer=require("inquirer"),chalk=require("chalk"),open=require("open"),promises=require("node:fs/promises"),os=require("node:os"),forge=require("node-forge");function __awaiter(e,t,r,n){return new(r||(r=Promise))(function(o,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(c,a)}s((n=n.apply(e,t||[])).next())})}function __generator(e,t){var r,n,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(s){return function(a){if(r)throw TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(c=0)),c;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,n=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(!(o=(o=c.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){c=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){c.label=a[1];break}if(6===a[0]&&c.label<o[1]){c.label=o[1],o=a;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(a);break}o[2]&&c.ops.pop(),c.trys.pop();continue}a=t.call(e,c)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}var readFileContent=function(e){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,promises.readFile(e)];case 1:return[2,t.sent().toString()]}})})},deleteFile=function(e){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,promises.unlink(e)];case 1:return t.sent(),[2]}})})},hasFileOrDir=function(e){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,promises.access(e,promises.constants.R_OK|promises.constants.W_OK)];case 1:return t.sent(),[2,!0];case 2:return t.sent(),[2,!1];case 3:return[2]}})})},writeFileContent=function(e,t){return __awaiter(void 0,void 0,void 0,function(){var r;return __generator(this,function(n){switch(n.label){case 0:return[4,hasFileOrDir(r=e.split("/").slice(0,-1).join("/"))];case 1:if(n.sent())return[3,3];return[4,promises.mkdir(r,{recursive:!0})];case 2:n.sent(),n.label=3;case 3:return[4,promises.writeFile(e,t)];case 4:return n.sent(),[2]}})})},appendFileContent=function(e,t){return __awaiter(void 0,void 0,void 0,function(){var r;return __generator(this,function(n){switch(n.label){case 0:return[4,hasFileOrDir(r=e.split("/").slice(0,-1).join("/"))];case 1:if(n.sent())return[3,3];return[4,promises.mkdir(r,{recursive:!0})];case 2:n.sent(),n.label=3;case 3:return[4,promises.appendFile(e,"".concat(t).concat(os.EOL))];case 4:return n.sent(),[2]}})})};!function(e){e.RSA="rsa",e.AES="aes"}(Encryption||(Encryption={}));var getPath=function(e){return"".concat(process.cwd(),"/.pass/").concat(e,".key.txt")},getCodeBookPath=function(){return"".concat(process.cwd(),"/.pass/code-book.txt")},getAes=function(){return forge.random.getBytesSync(32)},createAes=function(){return __awaiter(void 0,void 0,void 0,function(){var e,t;return __generator(this,function(r){switch(r.label){case 0:return[4,getAes()];case 1:return e=r.sent(),[4,writeFileContent(getPath(Encryption.AES),forge.util.bytesToHex(e))];case 2:return r.sent(),t=forge.util.bytesToHex(e),console.log(chalk.red("AES Private Key:")+chalk.yellow(" ".concat(t))),[2,t]}})})},decrypt$2=function(e,t){return new Promise(function(r,n){t&&e||n();try{var o=forge.util.hexToBytes(t.substring(0,32)),i=t.substring(32),c=forge.cipher.createDecipher("AES-CBC",forge.util.hexToBytes(e));c.start({iv:o}),c.update(forge.util.createBuffer(forge.util.hexToBytes(i))),c.finish();var a=c.output;r(a.toString())}catch(e){console.log(e,"error"),n(e)}})},encrypt$2=function(e,t){return new Promise(function(r,n){t&&e||n();var o=forge.util.hexToBytes(e);try{var i=forge.random.getBytesSync(16),c=forge.cipher.createCipher("AES-CBC",o);c.start({iv:i}),c.update(forge.util.createBuffer(t)),c.finish();var a=c.output,s=forge.util.bytesToHex(i)+forge.util.bytesToHex(a.getBytes());r(s)}catch(e){n(e)}})},setAes=function(){return __awaiter(void 0,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,inquirer.prompt([{type:"input",name:"key",message:"Enter your key:"}])];case 1:return e=t.sent(),[4,writeFileContent(getPath(Encryption.AES),e.key)];case 2:return t.sent(),[2]}})})},del$2=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){return[2,deleteFile(getPath(Encryption.AES))]})})},getRsa=function(){return new Promise(function(e,t){try{var r=forge.pki.rsa.generateKeyPair({bits:2048}),n=forge.pki.privateKeyToPem(r.privateKey),o=forge.pki.publicKeyToPem(r.publicKey);e({privateKey:n,publicKey:o})}catch(e){t(e)}})},createRsa=function(){return __awaiter(void 0,void 0,void 0,function(){var e,t,r,n,o;return __generator(this,function(i){switch(i.label){case 0:return[4,getRsa()];case 1:return t=(e=i.sent()).privateKey,r=e.publicKey,n=forge.util.encode64(t),o=forge.util.encode64(r),[4,writeFileContent(getPath("".concat(Encryption.RSA,".private")),n)];case 2:return i.sent(),[4,writeFileContent(getPath(Encryption.RSA),o)];case 3:return i.sent(),console.log(chalk.red("RSA Private Key:")+chalk.yellow(" ".concat(n))),console.log(chalk.red("RSA Public Key:")+chalk.yellow(" ".concat(o))),[2,o]}})})},decrypt$1=function(e,t){return new Promise(function(r,n){e&&t||n();try{var o=forge.util.decode64(e),i=forge.pki.privateKeyFromPem(o),c=forge.util.decode64(t),a=i.decrypt(c);r(a)}catch(e){n(e)}})},encrypt$1=function(e,t){return new Promise(function(r,n){e&&t||n();try{var o=forge.util.decode64(e),i=forge.pki.publicKeyFromPem(o).encrypt(t);r(forge.util.encode64(i))}catch(e){n(e)}})},setRsa=function(){return __awaiter(void 0,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,inquirer.prompt([{type:"input",name:"privateKey",message:"Enter your key:"},{type:"input",name:"key",message:"Enter your Pubkey:"}])];case 1:return e=t.sent(),[4,writeFileContent(getPath("".concat(Encryption.RSA,".private")),e.privateKey)];case 2:return t.sent(),[4,writeFileContent(getPath("".concat(Encryption.RSA)),e.key)];case 3:return t.sent(),[2]}})})},del$1=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,deleteFile(getPath(Encryption.RSA))];case 1:return e.sent(),[4,deleteFile(getPath("".concat(Encryption.RSA,".private")))];case 2:return e.sent(),[2]}})})},typeOptions=new Map([[Encryption.AES,{set:setAes,encrypt:encrypt$2,create:createAes,decrypt:decrypt$2,del:del$2}],[Encryption.RSA,{set:setRsa,encrypt:encrypt$1,create:createRsa,decrypt:decrypt$1,del:del$1}]]),set=function(e){return __awaiter(void 0,void 0,void 0,function(){var t,r,n,o;return __generator(this,function(i){switch(i.label){case 0:return[4,hasFileOrDir(getPath(e))];case 1:if(!i.sent())return[3,3];return[4,inquirer.prompt([{type:"confirm",name:"overwrite",message:"File already exists. Overwrite?"}])];case 2:return i.sent().overwrite?null===(r=null===(t=typeOptions.get(e))||void 0===t?void 0:t.set)||void 0===r||r.call(t):process.exit(1),[3,4];case 3:null===(o=null===(n=typeOptions.get(e))||void 0===n?void 0:n.set)||void 0===o||o.call(n),i.label=4;case 4:return[2]}})})},encrypt=function(e,t,r,n){return void 0===t&&(t=Encryption.AES),__awaiter(void 0,void 0,void 0,function(){var o,i,c,a,s,u,l,p,d,y,f,v,g,h;return __generator(this,function(w){switch(w.label){case 0:return o=getPath(t),i=getCodeBookPath(),[4,hasFileOrDir(o)];case 1:if(c=w.sent(),"string"!=typeof r)return[3,4];return[4,null===(p=null===(l=typeOptions.get(t))||void 0===l?void 0:l.encrypt)||void 0===p?void 0:p.call(l,r,e)];case 2:case 6:case 10:return a=w.sent(),[4,appendFileContent(i,"".concat(n||"unknown",": ").concat(a))];case 3:case 7:return w.sent(),console.log(chalk.green("Encryption successful.")),console.log(chalk.yellow("Your  encrypted code:"+chalk.green(a))),[3,12];case 4:if(!c)return[3,8];return[4,readFileContent(o)];case 5:return s=w.sent(),[4,null===(y=null===(d=typeOptions.get(t))||void 0===d?void 0:d.encrypt)||void 0===y?void 0:y.call(d,s,e)];case 8:return[4,null===(v=null===(f=typeOptions.get(t))||void 0===f?void 0:f.create)||void 0===v?void 0:v.call(f)];case 9:return u=w.sent()||"",[4,null===(h=null===(g=typeOptions.get(t))||void 0===g?void 0:g.encrypt)||void 0===h?void 0:h.call(g,u,e)];case 11:w.sent(),console.log(chalk.green("Encryption successful.")),console.log(chalk.yellow("Your  encrypted code:"+chalk.green(a))),w.label=12;case 12:return[2]}})})},decrypt=function(e,t,r){return void 0===t&&(t=Encryption.AES),__awaiter(void 0,void 0,void 0,function(){var n,o,i,c,a,s,u,l;return __generator(this,function(p){switch(p.label){case 0:return[4,hasFileOrDir(n=getPath(t===Encryption.RSA?"".concat(t,".private"):t))];case 1:if(o=p.sent(),"string"!=typeof r)return[3,3];return[4,null===(s=null===(a=typeOptions.get(t))||void 0===a?void 0:a.decrypt)||void 0===s?void 0:s.call(a,r,e)];case 2:case 5:return i=p.sent(),console.log(chalk.green("Decryption successful.")),console.log(chalk.yellow("Your  encrypted code:")+chalk.green(i)),[3,7];case 3:if(!o)return[3,6];return[4,readFileContent(n)];case 4:return c=p.sent(),[4,null===(l=null===(u=typeOptions.get(t))||void 0===u?void 0:u.decrypt)||void 0===l?void 0:l.call(u,c,e)];case 6:console.log(chalk.yellow("You have not yet set up the decryption private key")),p.label=7;case 7:return[2]}})})},del=function(e){return void 0===e&&(e=Encryption.AES),__awaiter(void 0,void 0,void 0,function(){var t,r;return __generator(this,function(n){switch(n.label){case 0:return[4,hasFileOrDir(getPath(e===Encryption.RSA?"".concat(e,".private"):e))];case 1:if(!n.sent())return[3,5];return[4,inquirer.prompt([{type:"confirm",name:"deleteKey",message:"Are you sure you want to delete the public/private key?"}])];case 2:if(!n.sent().deleteKey)return[3,4];return[4,null===(r=null===(t=typeOptions.get(e))||void 0===t?void 0:t.del)||void 0===r?void 0:r.call(t)];case 3:n.sent(),console.log(chalk.green("Deletion successful.")),n.label=4;case 4:return[3,6];case 5:console.log("The specified type of public/private key has not been generated locally."),n.label=6;case 6:return[2]}})})},exp=function(e){return __awaiter(void 0,void 0,void 0,function(){var t,r;return __generator(this,function(n){switch(n.label){case 0:return[4,hasFileOrDir(t=getCodeBookPath())];case 1:if(!n.sent())return[3,7];n.label=2;case 2:return n.trys.push([2,5,,6]),[4,readFileContent(t)];case 3:return r=n.sent(),[4,writeFileContent("".concat(e,"/code-book.txt"),r)];case 4:return n.sent(),console.log(chalk.green("Password book exported successfully.")),open(e),[3,6];case 5:return console.log(n.sent()),[3,6];case 6:return[3,8];case 7:console.log("Password book is not saved locally."),n.label=8;case 8:return[2]}})})};exports.decrypt=decrypt,exports.del=del,exports.encrypt=encrypt,exports.exp=exp,exports.set=set;
